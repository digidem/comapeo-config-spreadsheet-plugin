name: Deploy Script

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  release:
    types: [published]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Validate CLASP_ALL_JSON secret is present
        env:
          CLASP_ALL_JSON: ${{ secrets.CLASP_ALL_JSON }}
        run: |
          if [ -z "$CLASP_ALL_JSON" ]; then
            echo "::error::Missing or empty CLASP_ALL_JSON secret. Add the raw contents of .clasp.all.json to repo secrets."
            echo "HINT: If you are using environment secrets, set 'environment:' on the job so secrets are available."
            exit 1
          fi
          echo "$CLASP_ALL_JSON" > /tmp/.clasp.all.json

      - name: Validate CLASP_ALL_JSON structure
        run: |
          if ! jq -e 'type == "array"' /tmp/.clasp.all.json >/dev/null 2>&1; then
            echo "::error::CLASP_ALL_JSON must be a JSON array."
            exit 1
          fi
          if ! jq -e 'all(.[]; (has("name") and (.name | type == "string") and (.name | length > 0) and has("scriptId") and (.scriptId | type == "string") and (.scriptId | length > 0)))' /tmp/.clasp.all.json >/dev/null 2>&1; then
            echo "::error::Each entry in CLASP_ALL_JSON must have non-empty string fields: name, scriptId."
            exit 1
          fi

      - name: Set matrix output
        id: set-matrix
        run: |
          MATRIX=$(jq -c '. as $arr | {scripts: [range(0; $arr|length) | {index: ., name: $arr[.].name}]}' /tmp/.clasp.all.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        include: ${{ fromJson(needs.setup.outputs.matrix).scripts }}
      max-parallel: 4
      fail-fast: false

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install clasp
        run: sudo npm install @google/clasp@2.4.2 -g

      - name: Validate CLASPRC_JSON secret is present
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then
            echo "::error::Missing or empty CLASPRC_JSON secret. Add the raw contents of ~/.clasprc.json to repo secrets."
            echo "HINT: If you are using environment secrets, set 'environment:' on the job so secrets are available."
            exit 1
          fi
          echo "$CLASPRC_JSON" > ~/.clasprc.json

      - name: Validate .clasprc.json content
        run: |
          if [ ! -s ~/.clasprc.json ]; then
            echo "::error::~/.clasprc.json is missing or empty after writing CLASPRC_JSON secret."
            exit 1
          fi
          if jq -e 'type == "object"' ~/.clasprc.json >/dev/null 2>&1; then
            echo "Valid JSON object in .clasprc.json"
            exit 0
          fi
          if jq -e 'type == "string"' ~/.clasprc.json >/dev/null 2>&1; then
            echo "::error::CLASPRC_JSON looks like JSON encoded as a string."
            echo "HINT: Store raw JSON without wrapping quotes."
            exit 1
          fi
          if base64 -d ~/.clasprc.json >/dev/null 2>&1 && base64 -d ~/.clasprc.json | jq -e 'type == "object"' >/dev/null 2>&1; then
            echo "::error::CLASPRC_JSON appears to be base64-encoded JSON."
            echo "HINT: Decode it in the workflow before writing."
            exit 1
          fi
          echo "::error::Invalid JSON in CLASPRC_JSON secret."
          echo "HINT: Ensure CLASPRC_JSON is a valid JSON object like the contents of ~/.clasprc.json."
          exit 1

      - name: Validate clasp auth status
        run: |
          if ! clasp login --status >/dev/null 2>&1; then
            echo "::error::clasp authentication failed or is missing."
            echo "HINT: Ensure CLASPRC_JSON contains a valid token and refresh_token."
            exit 1
          fi

      - name: Prepare and push script (no ID logging)
        env:
          CLASP_ALL_JSON: ${{ secrets.CLASP_ALL_JSON }}
        run: |
          SCRIPT_JSON=$(echo "$CLASP_ALL_JSON" | jq -c ".[${{ matrix.index }}]")
          SCRIPT_ID=$(echo "$SCRIPT_JSON" | jq -r ".scriptId")
          if [ -z "$SCRIPT_ID" ] || [ "$SCRIPT_ID" = "null" ]; then
            echo "::error::Missing scriptId at index ${{ matrix.index }}"
            exit 1
          fi
          echo "::add-mask::$SCRIPT_ID"
          echo "Deploying to ${{ matrix.name }}"
          cat > .clasp.json <<EOF
{
  "scriptId": "$SCRIPT_ID",
  "rootDir": "./"
}
EOF
          clasp push -f

      - name: Deploy Script
        if: |
          (github.ref == 'refs/heads/main' || github.event_name == 'release')
        run: clasp deploy -d "${GITHUB_REF_NAME}"
